<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>医生版报告</title>
<style>

/* 优化后：添加注释分组 */
:root {
    /* 色彩 - 文本与背景 (Colors - Text & Background) */
    --fg: #222;
    --fg-soft: #444;
    --bg: #fff;
    --muted: #888;
    
    /* 色彩 - 语义 (Colors - Semantic) */
    --pri: #2e7d32;       /* 主要颜色，如成功 */
    --pri-weak: #e9f5eb;  /* 主要颜色的弱化背景 */
    --warn: #c62828;      /* 警告/危险色 */
    --bar: #0f766e;       /* 用于边框、强调条等 */
    
    /* 色彩 - UI组件 (Colors - UI Components) */
    --card: #f6f7f9;      /* 卡片背景 */
    --border: #ddd;       /* 边框 */
    --btn: #0ea5e9;       /* 按钮主色 */
    --btn-hover: #0284c7; /* 按钮悬浮色 */
}

html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); 
    font-family:"Noto Sans CJK SC","Microsoft YaHei","PingFang SC",Arial; }
body { font-size:14.5px; line-height:1.6; }
.page-container { max-width:1100px; margin:0 auto; padding:16px 20px 80px; }
.meta { color:var(--fg-soft); margin-bottom:12px; }
h1,h2,h3,h4 { color:#111; margin:.7em 0 .45em; position:relative; }
table { border-collapse:collapse; width:100%; margin:.4em 0 .8em; }
th,td { border:1px solid #ccc; padding:6px 8px; vertical-align:top; }
th { background:#f6f7f9; }
blockquote { color:#555; margin:.6em 0; padding-left:.8em; border-left:3px solid #ddd; }
img { max-width:100%; }
hr { border: 0; border-top: 1px solid #eee; margin: 1em 0; }

/* 批注工具条（通用） */
.anno-toolbar {
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px; z-index:9999; display:flex; gap:8px; align-items:center;
    background:linear-gradient(90deg,#0ea5e9,#06b6d4); color:#fff;
    padding:10px 12px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.15);
}
.anno-toolbar button, .anno-toolbar label.btn {
    appearance:none; border:0; border-radius:10px; padding:8px 10px; cursor:pointer; 
    font-weight:600; background:#ffffff; color:#0b3b48; transition:all .15s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.12);
}
.anno-toolbar button:hover, .anno-toolbar label.btn:hover { transform:translateY(-1px); }
.anno-toolbar .sep { width:1px; height:20px; background:rgba(255,255,255,.6); margin:0 4px; }
.hidden-input { display:none; }

/* 批注按钮（通用） */
.add-note-btn {
    display:none; position:absolute; right:-4px; top:50%; transform:translate(100%,-50%);
    background:var(--btn); color:#fff; border:0; padding:3px 8px; border-radius:10px; 
    font-size:12px; cursor:pointer;
}
.add-note-btn:hover { background:var(--btn-hover); }

/* 章节交互工具（通用容器） */
.section-tools {
    display:inline-flex; gap:8px; align-items:center; margin-left:8px; 
    transform:translateY(-1px); flex-wrap: wrap;
}
.section-tools select, .section-tools input[type="checkbox"] {
    font-size:12px; padding:2px 6px;
}
.section-tools .chip {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff;
}
.section-tools .btn-mini {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff; cursor:pointer;
}
.section-tools .btn-mini:hover { background:#f1f5f9; }

/* 批注卡片（通用） */
.anno-card {
    background:var(--card); border:1px solid var(--border); 
    border-left:4px solid var(--bar); border-radius:12px; padding:10px; 
    margin:8px 0 12px;
}
.anno-card .anno-head { 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:6px; color:var(--fg-soft); font-size:12px; 
}
.anno-card .anno-body[contenteditable="true"] {
    min-height:48px; padding:6px 8px; border-radius:8px; background:#fff; 
    border:1px dashed #cbd5e1; outline:none;
}
.anno-card .anno-actions { text-align:right; margin-top:6px; }
.anno-card .anno-actions button {
    background:#fff; border:1px solid #cbd5e1; border-radius:8px; 
    padding:4px 8px; cursor:pointer; margin-left:6px;
}
.anno-card .anno-actions button:hover { background:#f1f5f9; }

/* 全局批注（通用） */
.global-anno {
    background:#fff; border:1px solid var(--border); border-radius:14px; 
    padding:12px; margin:10px 0 18px; box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.global-anno h3 { margin-top:0; }
.global-anno .area { 
    width:100%; min-height:68px; resize:vertical; padding:8px; 
    border-radius:10px; border:1px solid #cbd5e1; 
}
.global-anno .actions { text-align:right; margin-top:6px; }
.muted { color:var(--muted); font-size:12px; }

@media print {
    .anno-toolbar { display:none!important; }
    .add-note-btn { display:none!important; }
    .section-tools { display:none!important; }
    .page-container { padding-bottom:0; }
    .global-anno { box-shadow:none; border:1px solid #ccc; }
    .anno-card { page-break-inside: avoid; }
}


/* 依从性报告专用样式 */
.adherence-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}
.adherence-good { background: #d1fae5; color: #065f46; }
.adherence-warn { background: #fef3c7; color: #92400e; }
.adherence-poor { background: #fee2e2; color: #991b1b; }

/* 紧迫程度状态卡片样式 */
.urgency-banner {
    margin: 20px 0;
    padding: 20px;
    border-radius: 12px;
    border-left: 6px solid;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    page-break-inside: avoid;
}

.urgency-banner.urgency-urgent {
    background: #fef2f2;
    border-left-color: #dc2626;
}

.urgency-banner.urgency-attention {
    background: #fffbeb;
    border-left-color: #f59e0b;
}

.urgency-banner.urgency-stable {
    background: #f0fdf4;
    border-left-color: #10b981;
}

.urgency-banner .urgency-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.urgency-banner .urgency-icon {
    font-size: 32px;
}

.urgency-banner h3 {
    margin: 0;
    font-size: 20px;
    color: #111827;
}

.urgency-banner .risk-score {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-left: 12px;
}

.urgency-urgent .risk-score {
    background: #dc2626;
    color: white;
}

.urgency-attention .risk-score {
    background: #f59e0b;
    color: white;
}

.urgency-stable .risk-score {
    background: #10b981;
    color: white;
}

.urgency-banner .reasoning {
    margin: 12px 0;
    font-size: 15px;
    line-height: 1.6;
    color: #374151;
}

.urgency-banner .key-concerns {
    margin: 12px 0;
}

.urgency-banner .key-concerns strong {
    color: #1f2937;
}

.urgency-banner .key-concerns ul {
    margin: 8px 0;
    padding-left: 20px;
}

.urgency-banner .key-concerns li {
    margin: 4px 0;
    color: #4b5563;
}

.urgency-banner .action-row {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0,0,0,0.1);
}

.urgency-banner .action-item {
    flex: 1;
}

.urgency-banner .action-item strong {
    display: block;
    color: #1f2937;
    margin-bottom: 4px;
}

.urgency-banner .action-item span {
    color: #4b5563;
}

.urgency-banner .verification-note {
    margin-top: 12px;
    padding: 8px 12px;
    background: rgba(0,0,0,0.05);
    border-radius: 6px;
    font-size: 13px;
    color: #6b7280;
}

.urgency-banner .verification-note.failed {
    background: #fef3c7;
    color: #92400e;
}

</style>
</head>
<body>
<div class="page-container" data-patient-id="patient_urgent_f28a88766f78" data-report-type="compliance" data-report-id="20251017_112507">
    <div class="meta">生成时间：2025-10-17 11:25:07 | 报告ID：20251017_112507</div>
    
    <section class="global-anno" id="global-anno">
        <h3>📝 全局批注（医生）</h3>
        <textarea class="area" id="globalAnnoArea" placeholder="在此填写整体意见；支持导出/导入与自动保存。"></textarea>
        <div class="actions muted">内容自动保存到浏览器（仅本机）。每份报告的批注独立存储。</div>
    </section>
    
    <h1>慢病阶段管理月报（医生版）</h1>
<h2>🚨 紧迫程度评估</h2>
<div class="urgency-banner urgency-urgent">
    <div class="urgency-header">
        <span class="urgency-icon">
            🔴

        </span>
        <div>
            <h3>🔴 紧急级</h3>
            <span class="risk-score">风险评分：52/100</span>
        </div>
    </div>

    <p class="reasoning"><strong>判断理由：</strong>患者血压、血糖、血脂等生理指标均在正常或可控范围内，无急性症状。但依从性存在明显问题，尤其是哮喘药物使用不规律，且血脂监测未完成。任务执行情况显示患者有漏服行为和对检查的抵触情绪，需加强监督与支持。综合风险中等，需医生定期审阅。</p>

    <div class="key-concerns">
        <strong>关键关注点：</strong>
        <ul>

            <li>哮喘药物使用不规律，存在漏服现象，可能增加发作风险。</li>

            <li>血脂监测未完成，影响长期管理效果。</li>

            <li>患者对检测存在抵触情绪，可能影响治疗依从性。</li>

            <li>重点任务执行波动：每3个月监测血脂指数 ：保持长期达标调整方剂 。（对话中未提及患者是否进行过血脂检测，仅提到患者对检查有抵触情绪，认为麻烦且担心费用。）</li>

        </ul>
    </div>

    <div class="action-row">
        <div class="action-item">
            <strong>建议行动：</strong>
            <span>建议1周内联系医生评估哮喘用药方案并安排血脂检测。</span>
        </div>
        <div class="action-item">
            <strong>建议随访间隔：</strong>
            <span>7 天</span>
        </div>
        <div class="action-item">
            <strong>需要医生介入：</strong>
            <span>是 ✓</span>
        </div>
    </div>


    <div class="verification-note failed">
        ⚠️ 规则校验调整：规则校验：检测到重点任务存在不遵从行为，提升至紧急级。
    </div>

</div>

<hr />
<h2>一、基本信息</h2>
<ul>
<li>姓名：None</li>
<li>性别：女</li>
<li>年龄：45</li>
<li>职业：公务员</li>
<li>文化程度：大专</li>
<li>家庭情况：与家人同住</li>
<li>联系方式：138-XXXX-5678</li>
<li>过敏史：青霉素</li>
<li>既往史：哮喘、高脂血症</li>
<li>家庭支持情况：—</li>
</ul>
<hr />
<h2>二、主要疾病诊断及治疗</h2>
<ul>
<li>疾病名称：哮喘 （ICD10: J45.909）</li>
<li>当前病情：中度</li>
<li>当前用药：布地奈德吸入粉雾剂 200微克/次，每日2次，口服吸入用药 每日两次（吸入）；沙美特罗替卡松粉吸入剂 50微克/次，每日2次，口服吸入用药 每日两次（吸入）；阿托伐他汀钙片 20毫克，每晚1次，口服用药 每日一次晚间服用</li>
<li>与指南推荐：</li>
<li>
<p>一致性评价：</p>
</li>
<li>
<p>疾病名称：高脂血症 （ICD10: E78.5）</p>
</li>
<li>当前病情：轻度</li>
<li>当前用药：布地奈德吸入粉雾剂 200微克/次，每日2次，口服吸入用药 每日两次（吸入）；沙美特罗替卡松粉吸入剂 50微克/次，每日2次，口服吸入用药 每日两次（吸入）；阿托伐他汀钙片 20毫克，每晚1次，口服用药 每日一次晚间服用</li>
<li>与指南推荐：</li>
<li>一致性评价：</li>
</ul>
<hr />
<hr />
<h2>三、核心监测指标</h2>
<table>
<thead>
<tr>
<th>指标</th>
<th>当前值</th>
<th>推荐目标</th>
<th>是否达标</th>
</tr>
</thead>
<tbody>
<tr>
<td>血压</td>
<td>129/82 mmHg</td>
<td>&lt; 140/90 mmHg</td>
<td>达标</td>
</tr>
<tr>
<td>空腹血糖</td>
<td>6.0 mmol/L</td>
<td>&lt; 7.0 mmol/L（空腹）</td>
<td>达标</td>
</tr>
<tr>
<td>HbA1c</td>
<td>7.2%</td>
<td>&lt; 7.0%</td>
<td>未达标</td>
</tr>
<tr>
<td>LDL-C</td>
<td>2.8 mmol/L</td>
<td>&lt; 2.6 mmol/L</td>
<td>未达标</td>
</tr>
<tr>
<td>BMI</td>
<td>24.2 kg/m²</td>
<td>18.5–24.9 kg/m²</td>
<td>达标</td>
</tr>
<tr>
<td>心率</td>
<td>69 bpm</td>
<td>60–100 bpm</td>
<td>达标</td>
</tr>
<tr>
<td>肾功能</td>
<td>eGFR 82 ml/min/1.73m²</td>
<td>eGFR ≥ 60 ml/min/1.73m²</td>
<td>达标</td>
</tr>
</tbody>
</table>
<h3>指标趋势图</h3>
<h4>血压变化</h4>
<p><img alt="" src="assets/bp_trend.png" /></p>
<h4>血糖变化</h4>
<p><img alt="" src="assets/glucose_trend.png" /></p>
<h4>体重/BMI/心率对比</h4>
<p><img alt="" src="assets/monthly_comparison.png" /></p>
<hr />
<h2>四、生活方式处方</h2>
<ul>
<li>饮食：低盐低脂饮食，避免油腻和高胆固醇食品。多吃新鲜蔬果和粗粮。</li>
<li>运动：+坚持每周最少3次适度有氧运动，如快走或太极。注意防止过敏原暴露。</li>
<li>睡眠：+保持充足睡眠，避免熬夜保证呼吸道健康。</li>
<li>心理：+学习放松技巧减少精神压力诱发哮喘发作。</li>
</ul>
<hr />
<h2>五、依从性与APP使用情况</h2>
<ul>
<li>打卡情况：近月打卡 0 天</li>
<li>症状反馈：症状反馈 0 次</li>
<li>在线咨询：线上咨询 0 次</li>
<li>问卷完成情况：问卷 0 次</li>
<li>依从性总体：近0条记录，完全遵从 0.0%</li>
</ul>
<h3>依从性趋势图</h3>
<p><img alt="" src="" /></p>
<hr />
<h2>六、重点遵从任务清单</h2>
<table>
<thead>
<tr>
<th>任务</th>
<th>执行频率</th>
<th>核心说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>每日按时使用吸入性激素等哮喘药物</td>
<td>每日两次医学指导下使用粉雾剂有效预防发作</td>
<td>认真掌握正确器械使用方法避免漏服致加重</td>
</tr>
<tr>
<td>每3个月监测血脂指数 ：保持长期达标调整方剂 。</td>
<td>每季度一次实验室检查必不可少 。</td>
<td>—</td>
</tr>
</tbody>
</table>
<hr />
<h2>七、健康管理提示（来源：AI智能分析）</h2>
<h3>1. 用药管理</h3>
<ul>
<li>状态：患者当前用药依从性状态未明确记录，可能存在潜在的不依从风险。</li>
<li>建议：建议患者严格按照医嘱使用吸入类药物，每日两次布地奈德和沙美特罗替卡松粉吸入剂，确保剂量和频率。同时，阿托伐他汀钙片需每晚固定时间服用。</li>
<li>医生补充：医生应关注患者是否理解用药方法，是否存在药物混淆或漏服情况，必要时进行用药教育或调整给药方式。</li>
<li>风险提示：不依从可能导致哮喘控制不佳、肺功能下降，以及高脂血症控制不理想，增加心血管疾病风险。</li>
</ul>
<h3>2. 指标监测</h3>
<ul>
<li>状态：各项生理指标基本在正常范围内，但需持续监测以确保长期稳定。</li>
<li>建议：建议每周至少监测血压、血糖、HbA1c、LDL一次，结合日常自我监测数据进行综合评估。</li>
<li>医生补充：医生需关注HbA1c是否持续控制在7%以下，血压是否维持在正常范围，血脂水平是否稳定。</li>
<li>风险提示：若HbA1c持续高于7.5%，可能提示糖尿病风险；血压升高可能增加心血管事件风险。</li>
</ul>
<h3>3. 运动与康复</h3>
<ul>
<li>状态：患者目前有规律运动计划，但需进一步确认执行情况。</li>
<li>建议：建议每周至少进行3次中等强度有氧运动（如快走、太极），每次30分钟以上，并注意避免在哮喘发作期剧烈运动。</li>
<li>医生补充：医生应建议患者在运动前后监测呼吸状况，避免诱发哮喘症状。</li>
<li>风险提示：缺乏运动可能导致体重增加、血脂水平上升，加重高脂血症及哮喘病情。</li>
</ul>
<h3>4. 饮食管理</h3>
<ul>
<li>状态：患者已采取低盐低脂饮食，符合慢性病管理要求。</li>
<li>建议：建议继续保持低盐低脂饮食，增加膳食纤维摄入，减少加工食品和高糖食物。</li>
<li>医生补充：医生可提供个性化营养方案，帮助患者优化饮食结构。</li>
<li>风险提示：若饮食控制不严，可能导致体重增加、血脂异常加重，影响病情控制。</li>
</ul>
<h3>5. 心理与家庭支持</h3>
<ul>
<li>状态：患者心理状态良好，有家庭支持，但需关注压力管理。</li>
<li>建议：建议学习放松技巧，如深呼吸、冥想，以缓解压力，预防哮喘发作。</li>
<li>医生补充：医生可考虑定期评估患者心理状态，必要时提供心理咨询或干预。</li>
<li>风险提示：长期压力可能诱发哮喘发作，影响治疗效果和生活质量。</li>
</ul>
<hr />
<h2>八、AI 综合分析</h2>
<ul>
<li>总结：患者为45岁女性公务员，有哮喘和高脂血症病史，目前各项生理指标基本控制良好，但存在潜在的不依从风险。需加强用药依从性、定期监测指标、保持规律运动、优化饮食结构，并关注心理状态与社会支持。</li>
<li>风险评估：主要风险包括哮喘控制不佳、高脂血症未达标、长期不依从导致病情恶化，以及心理压力可能诱发哮喘发作。</li>
<li>个性化建议：['加强患者用药教育，确保正确使用吸入类药物。', '制定个性化的运动计划，结合患者职业特点安排运动时间。', '定期随访，监测血压、血糖、血脂及HbA1c变化。', '提供营养指导，帮助患者优化饮食结构。', '关注患者心理状态，必要时提供心理支持或干预。', '鼓励家庭成员参与健康管理，增强患者依从性与社会支持。']</li>
</ul>
<hr />
<h2>九、参考文献</h2>
<hr />
<blockquote>
<p>报告生成日期：2025-10-17
报告周期：2025-10-04 至 2025-10-17</p>
</blockquote><hr />
<h2>附：依从性可视化</h2>
</div>


<div class="anno-toolbar" id="annoToolbar">
    <button id="toggleAnno">关闭批注模式</button>
    <div class="sep"></div>
    <button id="exportAnno">导出批注与交互数据</button>
    <label class="btn" for="importAnnoInput">导入数据</label>
    <input id="importAnnoInput" class="hidden-input" type="file" accept="application/json" />
    <button id="clearAnno">清空本地数据</button>
    <div class="sep"></div>
    <button id="printView">打印友好</button>
</div>


<script>

    (() => {
    // ==================== A. 通用核心变量与函数 ====================
    const patientId = document.querySelector('.page-container')?.dataset?.patientId || 'unknown';
    const reportType = document.querySelector('.page-container')?.dataset?.reportType || 'compliance';
    const reportId = document.querySelector('.page-container')?.dataset?.reportId || '20251017_112507';
    const LS_ANNOTATIONS = `report-annotations::${reportType}::${patientId}::${reportId}`;
    const LS_GLOBAL = `report-annotations-global::${reportType}::${patientId}::${reportId}`;
    const LS_INTERACTIONS = `report-interactions::${reportType}::${patientId}::${reportId}`;
    let annoMode = true;

    function nowStr() {
      const d = new Date();
      const pad = n => (n<10? '0'+n : ''+n);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function loadJSON(key, def) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
    function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val || {})); }
    function loadAnnotations() { return loadJSON(LS_ANNOTATIONS, {}); }
    function saveAnnotations(data) { saveJSON(LS_ANNOTATIONS, data); }
    function loadGlobal() { return localStorage.getItem(LS_GLOBAL) || ''; }
    function saveGlobal(val) { localStorage.setItem(LS_GLOBAL, val || ''); }
    function loadInteracts() { return loadJSON(LS_INTERACTIONS, {}); }
    function saveInteracts(obj) { saveJSON(LS_INTERACTIONS, obj); }

    // ==================== B. 资源编辑器专属逻辑 ====================
    function setupResourceEditor() {
        if (!window.TRIAGE_RESOURCES_DATA) return;
        const { allResources: ALL_RESOURCES, suggestedIds: SYSTEM_SUGGESTED_IDS } = window.TRIAGE_RESOURCES_DATA;
        let currentSelectedResourceIds = new Set();
        const STORAGE_KEY = 'triage_resources_selection';
        const editButton = document.querySelector('[data-act="edit-resources"]');
        if (!editButton) return;
        const modal = document.getElementById('resourceEditorModal');
        const modalBody = document.getElementById('resourceEditorContent');
        const displayAreaList = document.querySelector('#resource-display-area .resource-list');
        const confirmBtn = document.querySelector('.resource-modal-footer button.primary');
        const cancelBtn = document.querySelector('.resource-modal-footer button:not(.primary)');
        const closeIconBtn = document.querySelector('.resource-modal-header button');
        const countDisplay = document.querySelector('#resourceCount strong');

        function initializeState() {
            currentSelectedResourceIds.clear();
            const store = loadInteracts();
            const savedSelection = store[STORAGE_KEY];
            if (savedSelection && Array.isArray(savedSelection)) {
                currentSelectedResourceIds = new Set(savedSelection);
                console.log('✅ [资源] 加载已保存的选择:', savedSelection.length, '项');
            } else {
                currentSelectedResourceIds = new Set(SYSTEM_SUGGESTED_IDS);
                store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
                saveInteracts(store);
                console.log('✅ [资源] 使用系统推荐并已保存:', SYSTEM_SUGGESTED_IDS.length, '项');
            }
        }

        function updateCounter() {
            const count = modalBody.querySelectorAll('input:checked').length;
            if(countDisplay) countDisplay.textContent = count;
        }

        function openResourceEditor() {
            initializeState();
            modalBody.innerHTML = '';
            Object.entries(ALL_RESOURCES).forEach(([category, resources]) => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                modalBody.appendChild(categoryTitle);
                resources.forEach(item => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = item.id;
                    checkbox.checked = currentSelectedResourceIds.has(item.id);
                    checkbox.onchange = updateCounter;
                    label.appendChild(checkbox);
                    label.append(` ${item.name}`);
                    if(SYSTEM_SUGGESTED_IDS.includes(item.id)) {
                        const badge = document.createElement('span');
                        badge.className = 'system-badge';
                        badge.textContent = '[系统推荐]';
                        label.appendChild(badge);
                    }
                    modalBody.appendChild(label);
                });
            });
            updateCounter();
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeResourceEditor() {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function saveResourceSelection() {
            currentSelectedResourceIds = new Set(Array.from(modalBody.querySelectorAll('input:checked')).map(cb => cb.value));
            const store = loadInteracts();
            store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
            saveInteracts(store);
            console.log('💾 [资源] 已保存选择:', store[STORAGE_KEY].length, '项');
            renderDisplayArea();
            closeResourceEditor();
        }
        
        function renderDisplayArea() {
            if(!displayAreaList) return;
            displayAreaList.innerHTML = '';
            const selectedByCategory = {};
            const allResourcesFlat = Object.values(ALL_RESOURCES).flat();
            currentSelectedResourceIds.forEach(id => {
                const item = allResourcesFlat.find(i => i.id === id);
                if(item) {
                    const category = item.category || '未分类';
                    if (!selectedByCategory[category]) selectedByCategory[category] = [];
                    selectedByCategory[category].push(item);
                }
            });
            if (Object.keys(selectedByCategory).length === 0) {
                displayAreaList.innerHTML = '<li>医生未选择任何资源。</li>';
                return;
            }
            Object.entries(selectedByCategory).forEach(([categoryName, items]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${categoryName}:</strong> `;
                items.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'resource-item';
                    if (!SYSTEM_SUGGESTED_IDS.includes(item.id)) span.classList.add('added-by-user');
                    span.textContent = item.name;
                    li.appendChild(span);
                });
                displayAreaList.appendChild(li);
            });
        }
        
        if (editButton) editButton.addEventListener('click', openResourceEditor);
        if (confirmBtn) confirmBtn.addEventListener('click', saveResourceSelection);
        if (cancelBtn) cancelBtn.addEventListener('click', closeResourceEditor);
        if (closeIconBtn) closeIconBtn.addEventListener('click', closeResourceEditor);
        initializeState();
        renderDisplayArea();
    }

    // ==================== C. 通用批注与交互逻辑 ====================
    const SectionKindMap = [{"key": "disease", "includes": ["\u4e3b\u8981\u75be\u75c5\u8bca\u65ad", "\u6cbb\u7597", "\u8bca\u65ad\u53ca\u6cbb\u7597"], "tools_html": "\n                <span class=\"chip\">\u5904\u7f6e\uff1a</span>\n                <select data-k=\"disease.plan\">\n                    <option value=\"\">\u65e0</option>\n                    <option>\u7b80\u5316</option>\n                    <option>\u52a0\u5f3a</option>\n                    <option>\u6539\u836f</option>\n                    <option>\u4f1a\u8bca</option>\n                </select>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"disease.medChecked\"> \u5df2\u6838\u5bf9\u7528\u836f</label>\n            "}, {"key": "monitor", "includes": ["\u6838\u5fc3\u76d1\u6d4b\u6307\u6807", "\u76d1\u6d4b", "\u6307\u6807"], "tools_html": "\n                <span class=\"chip\">\u590d\u67e5\u5b89\u6392\uff1a</span>\n                <select data-k=\"monitor.recheck\">\n                    <option value=\"\">\u6309\u9700\u8981</option>\n                    <option>1\u5468</option>\n                    <option>2\u5468</option>\n                    <option>4\u5468</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"mark-recheck\" data-done-text=\"\u5df2\u6807\u8bb0\">\u8bb0\u4e3a\u9700\u590d\u67e5</button>\n            "}, {"key": "adherence", "includes": ["\u4f9d\u4ece", "\u4f9d\u4ece\u6027", "\u4f9d\u5f9e"], "tools_html": "\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"adherence.follow\"> \u9700\u968f\u8bbf</label>\n                <span class=\"chip\">\u5468\u671f\uff1a</span>\n                <select data-k=\"adherence.period\">\n                    <option>1\u5468</option>\n                    <option>2\u5468</option>\n                    <option selected>4\u5468</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"make-follow\" data-done-text=\"\u5df2\u8bb0\u5f55\">\u8bb0\u5f55\u968f\u8bbf\u4efb\u52a1</button>\n            "}, {"key": "lifestyle", "includes": ["\u751f\u6d3b\u65b9\u5f0f", "\u751f\u6d3b", "\u5e72\u9884"], "tools_html": "\n                <span class=\"chip\">\u751f\u6d3b\u65b9\u5f0f\u6307\u5bfc\uff1a</span>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.diet\"> \u996e\u98df</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.exercise\"> \u8fd0\u52a8</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.sleep\"> \u7761\u7720</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.psy\"> \u5fc3\u7406</label>\n                <button class=\"btn-mini\" data-act=\"lifestyle-complete\" data-done-text=\"\u5df2\u5b8c\u6210\">\u5b8c\u6210\u6559\u80b2</button>\n            "}, {"key": "tips", "includes": ["\u5efa\u8bae", "\u63d0\u793a", "\u968f\u8bbf\u5efa\u8bae", "\u6cbb\u7597\u5efa\u8bae"], "tools_html": "\n                <span class=\"chip\">\u5efa\u8bae\u91c7\u7eb3\u60c5\u51b5\uff1a</span>\n                <select data-k=\"tips.overall\">\n                    <option value=\"\">\u603b\u4f53\u8bc4\u4ef7</option>\n                    <option>\u5b8c\u5168\u91c7\u7eb3</option>\n                    <option>\u90e8\u5206\u91c7\u7eb3</option>\n                    <option>\u9700\u8981\u4fee\u6539</option>\n                    <option>\u91cd\u65b0\u5236\u5b9a</option>\n                </select>\n                <label class=\"chip\">\u91cd\u70b9\u5173\u6ce8\uff1a</label>\n                <select data-k=\"tips.focus\">\n                    <option value=\"\">\u9009\u62e9\u91cd\u70b9</option>\n                    <option>\u7528\u836f\u4f9d\u4ece\u6027</option>\n                    <option>\u8840\u538b\u76d1\u6d4b</option>\n                    <option>\u8840\u7cd6\u63a7\u5236</option>\n                    <option>\u751f\u6d3b\u65b9\u5f0f</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"create-plan\" data-done-text=\"\u5df2\u5236\u5b9a\">\u5236\u5b9a\u968f\u8bbf\u8ba1\u5212</button>\n            "}, {"key": "ai", "includes": ["AI", "\u4eba\u5de5\u667a\u80fd", "\u7efc\u5408\u5206\u6790", "\u603b\u7ed3", "\u98ce\u9669\u8bc4\u4f30"], "tools_html": "\n                <span class=\"chip\">AI\u5206\u6790\u786e\u8ba4\uff1a</span>\n                <select data-k=\"ai.summary\">\n                    <option value=\"\">\u603b\u7ed3</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <select data-k=\"ai.risk\">\n                    <option value=\"\">\u98ce\u9669\u8bc4\u4f30</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <select data-k=\"ai.recommendations\">\n                    <option value=\"\">\u5efa\u8bae</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"ai-approve\" data-done-text=\"\u5df2\u786e\u8ba4\">\u786e\u8ba4\u5206\u6790</button>\n            "}];

    function setupSectionAnchors() {
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach((h, idx) => {
        if (!h.id) {
            const text = h.textContent.replace(/[^a-zA-Z0-9一-龥]/g, '').substring(0, 15);
            h.id = text ? `sec-${text}-${idx}` : `sec-${idx}`;
        }
        const btn = document.createElement('button');
        btn.className = 'add-note-btn';
        btn.textContent = '➕ 批注';
        btn.addEventListener('click', () => createNoteCard(h.id));
        h.appendChild(btn);
      });
    }

    function refreshAnnoButtons() {
      document.querySelectorAll('.add-note-btn').forEach(b => b.style.display = annoMode ? 'inline-block' : 'none');
    }

    function renderNotes() {
      const store = loadAnnotations();
      Object.entries(store).forEach(([secId, arr]) => {
        const anchor = document.getElementById(secId);
        if (anchor) arr.forEach(n => insertNoteCardAfter(anchor, n));
      });
    }

    function createNoteCard(secId) {
      const payload = { id: `n-${Date.now()}`, ts: nowStr(), html: '' };
      const store = loadAnnotations();
      (store[secId] = store[secId] || []).push(payload);
      saveAnnotations(store);
      const anchor = document.getElementById(secId);
      if (anchor) insertNoteCardAfter(anchor, payload, true);
    }

    function insertNoteCardAfter(anchorEl, note, focus=false) {
      const card = document.createElement('div');
      card.className = 'anno-card';
      card.dataset.noteId = note.id;
      card.dataset.secId = anchorEl.id;
      card.innerHTML = `<div class="anno-head"><div>章节：<code>${anchorEl.textContent.replace('➕ 批注','').trim()}</code></div><div>时间：${note.ts}</div></div><div class="anno-body" contenteditable="true" spellcheck="false">${note.html || ''}</div><div class="anno-actions"><button data-act="del">删除</button></div>`;
      const body = card.querySelector('.anno-body');
      body.addEventListener('input', () => {
        const store = loadAnnotations();
        const item = (store[card.dataset.secId] || []).find(x => x.id === card.dataset.noteId);
        if (item) { item.html = body.innerHTML; saveAnnotations(store); }
      });
      card.querySelector('[data-act="del"]').addEventListener('click', () => {
        const store = loadAnnotations();
        let list = store[card.dataset.secId] || [];
        store[card.dataset.secId] = list.filter(x => x.id !== card.dataset.noteId);
        saveAnnotations(store);
        card.remove();
      });
      anchorEl.parentNode.insertBefore(card, anchorEl.nextSibling);
      if (focus) body.focus();
    }

    function injectToolsHTML() {
      if (!SectionKindMap || SectionKindMap.length === 0) return;
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
          const titleText = (h.textContent || '').replace(/[\s➕批注]/g, '');
          const config = SectionKindMap.find(m => m.includes && m.includes.some(k => titleText.includes(k)));
          if (config && config.tools_html) {
              const wrap = document.createElement('span');
              wrap.className = 'section-tools';
              wrap.innerHTML = config.tools_html;
              h.appendChild(wrap);
          }
      });
    }

    function activateInteractiveElements() {
        const store = loadInteracts();
        let hasNewValues = false;
        
        document.querySelectorAll('[data-k]').forEach(el => {
            let header = el.closest('h1, h2, h3, h4');
            if (!header) {
                const wrapper = el.closest('.decision-interactive, .physician-approval-form');
                if (wrapper && wrapper.previousElementSibling?.matches('h1, h2, h3, h4')) {
                    header = wrapper.previousElementSibling;
                }
            }
            
            if (!header) {
                console.warn('⚠️ [交互] 无法找到标题，跳过元素:', el.dataset.k);
                return;
            }
            
            const k = `${header.id}::${el.dataset.k}`;
            const savedValue = store[k];
            
            let currentValue;
            if (el.tagName === 'SELECT') {
                currentValue = el.value;
            } else if (el.type === 'checkbox') {
                currentValue = el.checked;
            } else if (el.type === 'radio') {
                if (el.checked) {
                    currentValue = el.value;
                }
            } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                currentValue = el.value;
            }
            
            if (savedValue !== undefined) {
                if (el.tagName === 'SELECT') {
                    el.value = savedValue;
                    console.log('🔄 [交互] 恢复下拉框:', k, '=', savedValue);
                } else if (el.type === 'checkbox') {
                    el.checked = !!savedValue;
                    console.log('🔄 [交互] 恢复复选框:', k, '=', savedValue);
                } else if (el.type === 'radio') {
                    if (el.value === savedValue) {
                        el.checked = true;
                        console.log('🔄 [交互] 恢复单选框:', k, '=', savedValue);
                    }
                } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.value = savedValue;
                    console.log('🔄 [交互] 恢复输入框:', k, '=', savedValue);
                }
            } else if (currentValue !== '' && currentValue !== undefined) {
                store[k] = currentValue;
                hasNewValues = true;
                console.log('💾 [交互] 保存预设值:', k, '=', currentValue);
            }
            
            el.addEventListener('change', () => {
                const cur = loadInteracts();
                if (el.type === 'checkbox') {
                    cur[k] = el.checked;
                } else if (el.type === 'radio') {
                    cur[k] = el.value;
                } else {
                    cur[k] = el.value;
                }
                saveInteracts(cur);
                console.log('💾 [交互] 保存:', k, '=', cur[k]);
            });
        });
        
        if (hasNewValues) {
            saveInteracts(store);
            console.log('✅ [交互] 已保存所有预设值到localStorage');
        }
    }

    function setupPathSwitching() {
        const switcher = document.querySelector('.path-switcher-select');
        const pathYes = document.getElementById('path-immediate-care');
        const pathNo = document.getElementById('path-home-observation');
        if (!switcher || !pathYes || !pathNo) return; 
        const handleSwitch = () => {
            pathYes.style.display = (switcher.value === 'yes') ? 'block' : 'none';
            pathNo.style.display = (switcher.value === 'no') ? 'block' : 'none';
        };
        switcher.addEventListener('change', handleSwitch);
        handleSwitch();
    }

    function setupToolbar() {
      const $toggle = document.getElementById('toggleAnno'), $export = document.getElementById('exportAnno'), $import = document.getElementById('importAnnoInput'), $clear = document.getElementById('clearAnno'), $print = document.getElementById('printView'), $global = document.getElementById('globalAnnoArea');
      $global.value = loadGlobal();
      $global.addEventListener('input', () => saveGlobal($global.value));
      $toggle.addEventListener('click', () => {
        annoMode = !annoMode;
        $toggle.textContent = annoMode ? '关闭批注模式' : '开启批注模式';
        refreshAnnoButtons();
      });
      $export.addEventListener('click', () => {
        const data = { patient_id: patientId, report_type: reportType, report_id: reportId, exported_at: nowStr(), global: $global.value || '', sections: loadAnnotations(), interactions: loadInteracts() };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = `annotations_${reportType}_${patientId}_${reportId}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      $import.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (data?.global !== undefined) saveGlobal(data.global);
            if (data?.sections) saveAnnotations(data.sections);
            if (data?.interactions) saveInteracts(data.interactions);
            location.reload();
          } catch (err) { alert('导入失败：JSON格式不正确'); }
        };
        reader.readAsText(f, 'utf-8');
        e.target.value = '';
      });
      $clear.addEventListener('click', () => {
        if (confirm('确定清空本报告的所有本地数据吗？')) {
            localStorage.removeItem(LS_ANNOTATIONS);
            localStorage.removeItem(LS_GLOBAL);
            localStorage.removeItem(LS_INTERACTIONS);
            location.reload();
        }
      });
      $print.addEventListener('click', () => window.print());
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupSectionAnchors();
        injectToolsHTML();
        activateInteractiveElements();
        setupPathSwitching();
        setupResourceEditor();
        renderNotes();
        setupToolbar();
        refreshAnnoButtons();
    });

    })();
</script>
</body>
</html>