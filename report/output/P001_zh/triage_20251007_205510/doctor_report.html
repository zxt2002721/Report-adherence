<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åˆ†è¯ŠæŠ¥å‘Š - P001_zh</title>
<style>

/* ä¼˜åŒ–åï¼šæ·»åŠ æ³¨é‡Šåˆ†ç»„ */
:root {
    /* è‰²å½© - æ–‡æœ¬ä¸èƒŒæ™¯ (Colors - Text & Background) */
    --fg: #222;
    --fg-soft: #444;
    --bg: #fff;
    --muted: #888;
    
    /* è‰²å½© - è¯­ä¹‰ (Colors - Semantic) */
    --pri: #2e7d32;       /* ä¸»è¦é¢œè‰²ï¼Œå¦‚æˆåŠŸ */
    --pri-weak: #e9f5eb;  /* ä¸»è¦é¢œè‰²çš„å¼±åŒ–èƒŒæ™¯ */
    --warn: #c62828;      /* è­¦å‘Š/å±é™©è‰² */
    --bar: #0f766e;       /* ç”¨äºè¾¹æ¡†ã€å¼ºè°ƒæ¡ç­‰ */
    
    /* è‰²å½© - UIç»„ä»¶ (Colors - UI Components) */
    --card: #f6f7f9;      /* å¡ç‰‡èƒŒæ™¯ */
    --border: #ddd;       /* è¾¹æ¡† */
    --btn: #0ea5e9;       /* æŒ‰é’®ä¸»è‰² */
    --btn-hover: #0284c7; /* æŒ‰é’®æ‚¬æµ®è‰² */
}

html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); 
    font-family:"Noto Sans CJK SC","Microsoft YaHei","PingFang SC",Arial; }
body { font-size:14.5px; line-height:1.6; }
.page-container { max-width:1100px; margin:0 auto; padding:16px 20px 80px; }
.meta { color:var(--fg-soft); margin-bottom:12px; }
h1,h2,h3,h4 { color:#111; margin:.7em 0 .45em; position:relative; }
table { border-collapse:collapse; width:100%; margin:.4em 0 .8em; }
th,td { border:1px solid #ccc; padding:6px 8px; vertical-align:top; }
th { background:#f6f7f9; }
blockquote { color:#555; margin:.6em 0; padding-left:.8em; border-left:3px solid #ddd; }
img { max-width:100%; }
hr { border: 0; border-top: 1px solid #eee; margin: 1em 0; }

/* æ‰¹æ³¨å·¥å…·æ¡ï¼ˆé€šç”¨ï¼‰ */
.anno-toolbar {
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px; z-index:9999; display:flex; gap:8px; align-items:center;
    background:linear-gradient(90deg,#0ea5e9,#06b6d4); color:#fff;
    padding:10px 12px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.15);
}
.anno-toolbar button, .anno-toolbar label.btn {
    appearance:none; border:0; border-radius:10px; padding:8px 10px; cursor:pointer; 
    font-weight:600; background:#ffffff; color:#0b3b48; transition:all .15s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.12);
}
.anno-toolbar button:hover, .anno-toolbar label.btn:hover { transform:translateY(-1px); }
.anno-toolbar .sep { width:1px; height:20px; background:rgba(255,255,255,.6); margin:0 4px; }
.hidden-input { display:none; }

/* æ‰¹æ³¨æŒ‰é’®ï¼ˆé€šç”¨ï¼‰ */
.add-note-btn {
    display:none; position:absolute; right:-4px; top:50%; transform:translate(100%,-50%);
    background:var(--btn); color:#fff; border:0; padding:3px 8px; border-radius:10px; 
    font-size:12px; cursor:pointer;
}
.add-note-btn:hover { background:var(--btn-hover); }

/* ç« èŠ‚äº¤äº’å·¥å…·ï¼ˆé€šç”¨å®¹å™¨ï¼‰ */
.section-tools {
    display:inline-flex; gap:8px; align-items:center; margin-left:8px; 
    transform:translateY(-1px); flex-wrap: wrap;
}
.section-tools select, .section-tools input[type="checkbox"] {
    font-size:12px; padding:2px 6px;
}
.section-tools .chip {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff;
}
.section-tools .btn-mini {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff; cursor:pointer;
}
.section-tools .btn-mini:hover { background:#f1f5f9; }

/* æ‰¹æ³¨å¡ç‰‡ï¼ˆé€šç”¨ï¼‰ */
.anno-card {
    background:var(--card); border:1px solid var(--border); 
    border-left:4px solid var(--bar); border-radius:12px; padding:10px; 
    margin:8px 0 12px;
}
.anno-card .anno-head { 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:6px; color:var(--fg-soft); font-size:12px; 
}
.anno-card .anno-body[contenteditable="true"] {
    min-height:48px; padding:6px 8px; border-radius:8px; background:#fff; 
    border:1px dashed #cbd5e1; outline:none;
}
.anno-card .anno-actions { text-align:right; margin-top:6px; }
.anno-card .anno-actions button {
    background:#fff; border:1px solid #cbd5e1; border-radius:8px; 
    padding:4px 8px; cursor:pointer; margin-left:6px;
}
.anno-card .anno-actions button:hover { background:#f1f5f9; }

/* å…¨å±€æ‰¹æ³¨ï¼ˆé€šç”¨ï¼‰ */
.global-anno {
    background:#fff; border:1px solid var(--border); border-radius:14px; 
    padding:12px; margin:10px 0 18px; box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.global-anno h3 { margin-top:0; }
.global-anno .area { 
    width:100%; min-height:68px; resize:vertical; padding:8px; 
    border-radius:10px; border:1px solid #cbd5e1; 
}
.global-anno .actions { text-align:right; margin-top:6px; }
.muted { color:var(--muted); font-size:12px; }

@media print {
    .anno-toolbar { display:none!important; }
    .add-note-btn { display:none!important; }
    .section-tools { display:none!important; }
    .page-container { padding-bottom:0; }
    .global-anno { box-shadow:none; border:1px solid #ccc; }
    .anno-card { page-break-inside: avoid; }
}


        /* === åˆ†è¯ŠæŠ¥å‘Šä¸“å±æ ·å¼ === */
        .decision {
            padding: 15px; border-radius: 8px; margin: 1.2em 0;
            border-left: 5px solid var(--bar); background: var(--card);
        }
        .summary.empty { background: #fff3cd; color: #856404; }
        .evidence {
            font-size: 0.9em; color: var(--muted); margin-top: 8px;
            padding-left: 15px; border-left: 3px solid var(--border);
        }
        .badge {
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            font-size: 0.9em; font-weight: bold; color: white;
        }
        .badge-yes, .badge-high, .badge-é«˜ { background: var(--warn); }
        .badge-no, .badge-low, .badge-ä½ { background: var(--pri); }
        .badge-medium, .badge-ä¸­ { background: #f39c12; }
        .badge-esi { background: var(--btn); }

        .resource-display-area { width: 100%; }
        .resource-list { list-style-type: none; padding-left: 0; font-size: 0.9em; }
        .resource-list li { margin-bottom: 5px; }
        .resource-item {
            display: inline-block; padding: 2px 8px; background: var(--card);
            border: 1px solid var(--border); border-radius: 6px; margin: 2px;
        }
        .resource-item.added-by-user {
            background: #fee2e2; color: #991b1b;
            border-color: #fecaca; font-weight: bold;
        }

        /* === åŒ»é™¢æ¨èæ ·å¼ === */
        .hospital-recommendation {
            background: #fff; border: 1px solid var(--border);
            border-radius: 10px; padding: 16px; margin: 16px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .hospital-recommendation[data-priority="1"] {
            border-left: 5px solid #2e7d32;
        }
        .hospital-recommendation[data-priority="2"] {
            border-left: 5px solid #0ea5e9;
        }
        .hospital-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 12px; flex-wrap: wrap;
        }
        .hospital-header h5 {
            margin: 0; font-size: 1.1em; color: #111;
        }
        .priority-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 4px 10px; border-radius: 12px;
            font-size: 0.85em; font-weight: bold;
        }
        .hospital-details {
            line-height: 1.8; color: var(--fg-soft);
        }
        .hospital-details p {
            margin: 6px 0;
        }
        .hospital-details strong {
            color: var(--fg);
        }
        .hospital-details code {
            background: #f1f5f9; padding: 2px 6px; border-radius: 4px;
            font-size: 0.9em; color: #0ea5e9;
        }
        .critical-info {
            background: #e9f5eb; padding: 8px 12px; border-radius: 6px;
            border-left: 3px solid var(--pri);
        }
        .warning-info {
            background: #fff3cd; padding: 8px 12px; border-radius: 6px;
            border-left: 3px solid #f39c12; color: #856404;
        }
        .hospital-details details {
            margin: 10px 0; padding: 10px;
            background: var(--card); border-radius: 8px;
        }
        .hospital-details summary {
            cursor: pointer; font-weight: 600;
            color: var(--btn); user-select: none;
        }
        .hospital-details summary:hover {
            color: var(--btn-hover);
        }
        .hospital-details ul {
            margin: 8px 0; padding-left: 20px;
        }
        .hospital-details li {
            margin: 4px 0;
        }
        .risk-æ— , .risk-æä½ { color: var(--pri); font-weight: bold; }
        .risk-ä½ { color: #2e7d32; }
        .risk-ä¸­, .risk-ä¸­ç­‰ { color: #f39c12; font-weight: bold; }
        .risk-é«˜ { color: var(--warn); font-weight: bold; }

        /* === èµ„æºç¼–è¾‘å™¨å¼¹çª— (Modal) æ ·å¼ === */
        body.modal-open { overflow: hidden; }
        .resource-modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6);
            z-index: 10000; 
            align-items: center; 
            justify-content: center;
        }
        .resource-modal-content {
            background: white; width: 90%; max-width: 800px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; max-height: 85vh;
        }
        .resource-modal-header {
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .resource-modal-header h3 { margin: 0; font-size: 1.2em; }
        .resource-modal-body { padding: 24px; overflow-y: auto; }
        .resource-modal-footer {
            padding: 16px 24px; border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items:center; gap: 12px;
            background: var(--card);
        }
        .resource-modal-footer button {
            padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
            background: #fff; cursor: pointer; font-size: 14px; transition: background 0.2s;
        }
        .resource-modal-footer button:hover { background: #e9ecef; }
        .resource-modal-footer button.primary {
            background: var(--btn); color: #fff; border-color: var(--btn);
        }
        .resource-modal-footer button.primary:hover { background: var(--btn-hover); }
        .resource-modal-body h4 {
            color:#34495e; margin-bottom:10px; font-size:1.1em;
        }
        .resource-modal-body label {
            display: block; padding: 8px 12px; margin-bottom: 5px; 
            background: #f8f9fa; border-radius: 6px; cursor: pointer;
            transition: background 0.2s; display: flex; align-items: center;
        }
        .resource-modal-body label:hover {
            background: #e9ecef;
        }
        .resource-modal-body input[type="checkbox"] {
            margin-right: 10px; width: 16px; height: 16px;
        }
        .system-badge {
            color:var(--btn); font-size:0.8em; margin-left:8px; font-weight: 500;
        }

        /* === åŒ»ç”Ÿå®¡æ‰¹è¡¨å•æ ·å¼ === */
        .physician-approval-form {
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .approval-table {
            width: 100%;
            border-collapse: collapse;
        }
        .approval-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        .approval-table tr:last-child td {
            border-bottom: none;
        }
        .form-input {
            font-family: inherit;
            font-size: 14px;
        }
        .signature-input {
            border-bottom: 2px solid #0ea5e9 !important;
            background: #f8f9fa;
        }
        .approval-table input[type="radio"] {
            margin-right: 6px;
            transform: scale(1.2);
        }
        
</style>
</head>
<body>
<div class="page-container" data-patient-id="P001_zh" data-report-type="triage" data-report-id="20251007_205510">
    <div class="meta">ç”Ÿæˆæ—¶é—´ï¼š2025-10-07 20:55:10 | æŠ¥å‘ŠIDï¼š20251007_205510</div>
    
    <section class="global-anno" id="global-anno">
        <h3>ğŸ“ å…¨å±€æ‰¹æ³¨ï¼ˆåŒ»ç”Ÿï¼‰</h3>
        <textarea class="area" id="globalAnnoArea" placeholder="åœ¨æ­¤å¡«å†™æ•´ä½“æ„è§ï¼›æ”¯æŒå¯¼å‡º/å¯¼å…¥ä¸è‡ªåŠ¨ä¿å­˜ã€‚"></textarea>
        <div class="actions muted">å†…å®¹è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ï¼ˆä»…æœ¬æœºï¼‰ã€‚æ¯ä»½æŠ¥å‘Šçš„æ‰¹æ³¨ç‹¬ç«‹å­˜å‚¨ã€‚</div>
    </section>
    
    <h1>åˆ†è¯Šè¯„ä¼°æŠ¥å‘Š</h1>
<h2>ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
<ul>
<li><strong>æ‚£è€…ID:</strong> P001_zh</li>
<li><strong>æ€§åˆ«:</strong> å¥³</li>
<li><strong>å¹´é¾„:</strong> 52</li>
<li><strong>ä¸»è¯‰:</strong> è…¹éƒ¨èƒ€å¤§ä¸ç–¼ç—›åŠ é‡</li>
<li><strong>è¿‡æ•å²:</strong> æ— è¿‡æ•å²</li>
<li><strong>æ—¢å¾€å²:</strong> ä¸™å‹è‚ç‚ç›¸å…³è‚ç¡¬åŒ–ã€äººç±»å…ç–«ç¼ºé™·ç—…æ¯’ï¼ˆHIVï¼‰æ„ŸæŸ“ã€æ…¢æ€§é˜»å¡æ€§è‚ºç–¾ç—…ï¼ˆCOPDï¼‰ã€åŒç›¸æƒ…æ„Ÿéšœç¢ã€åˆ›ä¼¤ååº”æ¿€éšœç¢ï¼ˆPTSDï¼‰ã€è‚›é—¨ä¸Šçš®ä¸å…¸å‹å¢ç”Ÿã€çš®è‚¤ç™Œ</li>
<li><strong>å½“å‰ç”¨è¯:</strong> æ²™ä¸èƒºé†‡ 2å–· å¸å…¥ æ¯4å°æ—¶; æ©æ›²ä»–æ»¨-æ›¿è¯ºç¦éŸ¦ 1ç‰‡ å£æœ æ¯æ—¥; å‘‹å¡ç±³ 20 mg å£æœ æ¯æ—¥; å¼‚ä¸™æ‰˜æº´é“µ 1æ¬¡é›¾åŒ– å¸å…¥ æ¯6å°æ—¶; å°¼å¤ä¸è´´ç‰‡ 14 mg ç»çš® æ¯æ—¥; æ‹‰æ›¿æ‹‰éŸ¦ 400 mg å£æœ æ¯æ—¥ä¸¤æ¬¡; èºå†…é…¯ 50 mg å£æœ æ¯æ—¥</li>
</ul>
<hr />
<h2>äºŒã€æ€¥è¯Šç”Ÿå‘½ä½“å¾</h2>
<ul>
<li><strong>ä½“æ¸©:</strong> 98.4Â°F</li>
<li><strong>å¿ƒç‡:</strong> 70.0 æ¬¡/åˆ†</li>
<li><strong>å‘¼å¸:</strong> 16.0 æ¬¡/åˆ†</li>
<li><strong>è¡€æ°§:</strong> 97.0%</li>
<li><strong>è¡€å‹:</strong> 106.0/63.0 mmHg</li>
</ul>
<hr />
<h2>ä¸‰ã€AIåˆ†è¯Šå†³ç­–</h2>
<h4>é—®è¯Šæ‘˜è¦</h4>
<div class="summary">
    ä¸€ä½52å²å¥³æ€§ï¼Œæœ‰HCVè‚ç¡¬åŒ–å’Œè…¹æ°´ç—…å²ï¼Œä¸»è¯‰è…¹èƒ€è…¹ç—›åŠ é‡ä¸€å‘¨ã€‚æ‚£è€…è‡ªè¿°æ•°å‘¨å‰åœç”¨äº†åˆ©å°¿å‰‚ï¼ˆå‘‹å¡ç±³å’Œèºå†…é…¯ï¼‰ã€‚éœ€è¦å…³æ³¨çš„æ˜¯ï¼Œå¥¹åœ¨æ€¥è¯Šå®¤å‡ºç°äº†çŸ­æš‚çš„æ„è¯†æ¨¡ç³Šï¼Œå¹¶ä¸”æŠ¥å‘Šæœ‰ç‰™é¾ˆå‡ºè¡€ï¼Œé«˜åº¦æç¤ºè‚åŠŸèƒ½å¤±ä»£å¿ï¼Œå¯èƒ½å­˜åœ¨æ—©æœŸè‚æ€§è„‘ç—…å’Œå‡è¡€åŠŸèƒ½éšœç¢ã€‚ç”Ÿå‘½ä½“å¾ç›®å‰å¹³ç¨³ï¼šæ— å‘çƒ­ï¼Œå¿ƒç‡70ï¼Œå‘¼å¸16ï¼Œè¡€æ°§97%ï¼ˆå®¤å†…ç©ºæ°”ï¼‰ã€‚è¡€å‹åè½¯ï¼Œä¸º106/63 mmHgã€‚æ‚£è€…å¦è®¤å‘çƒ§ã€å‘¼å¸å›°éš¾æˆ–æ¶å¿ƒå‘•åç­‰ç—‡çŠ¶ã€‚å…¶ä»–é‡è¦ç—…å²åŒ…æ‹¬HIVï¼ˆæ­£åœ¨æ²»ç–—ï¼‰å’ŒCOPDã€‚
</div>

<h4>3.2 åˆæ­¥åˆ¤æ–­ä¸ESIåˆ†çº§</h4>
<div class="decision-interactive">
    <div class="form-group">
        <label for="judgment-select">åˆæ­¥åˆ¤æ–­:</label>

        <select id="judgment-select" class="path-switcher-select" data-k="judgment.final">
            <option value="yes" >å»ºè®®ç«‹å³å°±åŒ»</option>
            <option value="no" >å¯å±…å®¶è§‚å¯Ÿ</option>
        </select>
    </div>
    <div class="form-group">
        <label for="esi-select">ESIç­‰çº§:</label>
        <select id="esi-select" data-k="esi.level">

            <option value="1" >1 - éœ€æŠ¢æ•‘</option>
            <option value="2" >2 - é«˜å±</option>
            <option value="3" selected>3 - ç´§æ€¥</option>
            <option value="4" >4 - æ¬¡ç´§æ€¥</option>
            <option value="5" >5 - éç´§æ€¥</option>
        </select>
    </div>
</div>

<div id="path-immediate-care">  
    <h4>3.3 èµ„æºåˆ¤æ–­</h4>
    <div class="decision-interactive">

        <div id="resource-display-area" class="resource-display-area">
            <p style="margin:0; font-weight:bold;">æ¨¡å‹æ¨èèµ„æº:</p>
            <ul class="resource-list">

                <li><strong>åºŠæ—è¯„ä¼°:</strong> 

                <span class="resource-item">ç”Ÿå‘½ä½“å¾ä¸å¿ƒç”µç›‘æŠ¤</span><span class="resource-item">ä½“æ ¼æ£€æŸ¥</span>
                </li>

                <li><strong>å®éªŒå®¤æ£€æŸ¥:</strong> 

                <span class="resource-item">è¡€å¸¸è§„</span><span class="resource-item">åŸºç¡€/å…¨é¢ä»£è°¢ç»„åˆ</span><span class="resource-item">ç‰¹å®šå™¨å®˜åŠŸèƒ½æ ‡å¿—ç‰©ï¼ˆå¦‚è„‚è‚ªé…¶ã€è‚åŠŸã€è‚Œé…¸æ¿€é…¶ï¼‰</span><span class="resource-item">å‡è¡€åŠŸèƒ½ï¼ˆPT/INRã€APTTï¼‰</span><span class="resource-item">å°¿å¸¸è§„åŠé•œæ£€</span><span class="resource-item">å„ç±»æ ‡æœ¬åŸ¹å…»ä¸æ¶‚ç‰‡ï¼ˆè¡€ã€å°¿ã€ç—°ã€ä¼¤å£ç­‰ï¼‰</span>
                </li>

                <li><strong>å½±åƒæ£€æŸ¥:</strong> 

                <span class="resource-item">Xçº¿æ£€æŸ¥</span><span class="resource-item">è¶…å£°æ£€æŸ¥</span>
                </li>

                <li><strong>è¯Šæ–­æ€§æ“ä½œ:</strong> 

                <span class="resource-item">è¯Šæ–­æ€§æ“ä½œï¼ˆå¦‚è…°ç©¿ã€è…¹è…”ç©¿åˆºã€å…³èŠ‚ç©¿åˆºç­‰ï¼‰</span>
                </li>

            </ul>
        </div>
        <button class="btn-mini" data-act="edit-resources">ğŸ“ ç¼–è¾‘èµ„æº</button>
    </div>

    <h4>3.4 æœ€å¤§ç­‰å¾…æ—¶é—´</h4>
    <div class="decision-interactive">
        <label for="time-select">æœ€å¤§ç­‰å¾…æ—¶é—´:</label>
        <select id="time-select" data-k="time.max">
            <option value="0" >ç«‹å³</option>
            <option value="10" >10åˆ†é’Ÿå†…</option>
            <option value="30" >30åˆ†é’Ÿå†…</option>
            <option value="60" >60åˆ†é’Ÿå†…</option>
            <option value="120" >120åˆ†é’Ÿå†…</option>
        </select>
    </div>

    <h4>3.5 æ¶åŒ–é£é™©</h4>
    <div class="decision-interactive">
        <label for="risk-select">æ¶åŒ–é£é™©:</label>
        <select id="risk-select" data-k="risk.deterioration">
            <option value="ä½" >ä½é£é™©</option>
            <option value="ä¸­" >ä¸­é£é™©</option>
            <option value="é«˜" selected>é«˜é£é™©</option>
        </select>
    </div>
<h4>3.6 åŒ»é™¢æ¨è</h4>



    <div class="hospital-recommendation" data-priority="1">
        <div class="hospital-header">
            <span class="priority-badge">æ¨è 1</span>
            <h5>å¸‚ä¸­å¿ƒåŒ»é™¢ (ä¸‰çº§ç”²ç­‰)</h5>

            <span class="badge badge-esi">ç³»ç»Ÿæ¨è</span>

        </div>

        <div class="hospital-details">
            <p><strong>ğŸ¥ æ€¥è¯ŠçŠ¶æ€ï¼š</strong>ç¹å¿™</p>
            <p><strong>â±ï¸ é¢„è®¡æ€»ç­‰å¾…æ—¶é—´ï¼š</strong>70 åˆ†é’Ÿ</p>
            <p><strong>ğŸ“‹ æ’é˜Ÿæƒ…å†µï¼š</strong>ä¸­ç­‰ï¼ˆé¢„è®¡ç¬¬8-12ä½ï¼‰</p>

            <p><strong>ğŸ”¬ èµ„æºåŒ¹é…åº¦ï¼š</strong>
                <span class="badge badge-high">
                    100%
                </span>
            </p>


            <div class="critical-info">
                <strong>âœ… å…³é”®èµ„æºå¯ç”¨ï¼š</strong><br>

                <span class="resource-item" style="display:inline-block; margin:4px 4px 4px 0;">è¯Šæ–­æ€§ç©¿åˆºæ“ä½œ (è…°ç©¿/è…¹ç©¿/å…³èŠ‚ç©¿åˆº)</span>

            </div>




            <details>
                <summary><strong>ğŸ“‹ æ¨èç†ç”±</strong></summary>
                <p style="margin-top:8px; line-height:1.6;">æ‚£è€…ä¸ºè‚ç¡¬åŒ–å¹¶å‘è…¹æ°´æ¶åŒ–ï¼Œéœ€è¦è¯Šæ–­æ€§è…¹ç©¿ä»¥æ’é™¤è‡ªå‘æ€§ç»†èŒæ€§è…¹è†œç‚ï¼ˆSBPï¼‰ã€‚è¯¥æ“ä½œä»…ä¸‰çº§åŒ»é™¢æ€¥è¯Šç§‘å¯å®æ–½ï¼Œä¸”æ‚£è€…å¯èƒ½éœ€è¦ä¸“ç§‘ä¼šè¯Šå’Œä½é™¢æ²»ç–—ã€‚è™½ç„¶ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œä½†é¿å…äº†è½¬é™¢é£é™©ã€‚</p>
            </details>

            <details>
                <summary><strong>âš–ï¸ ä¼˜åŠ£åŠ¿åˆ†æ</strong></summary>
                <div style="margin-top:8px;">
                    <p><strong>ä¼˜åŠ¿ï¼š</strong></p>
                    <ul>

                        <li>å…·å¤‡å®Œæ•´çš„æ€¥è¯Šèµ„æºï¼ŒåŒ…æ‹¬è¯Šæ–­æ€§ç©¿åˆºèƒ½åŠ›</li>

                        <li>24å°æ—¶è‚ç—…ä¸“ç§‘åŒ»ç”Ÿåœ¨å²—</li>

                        <li>é…å¤‡é‡ç—‡ç›‘æŠ¤è®¾å¤‡</li>

                        <li>å¦‚éœ€ä½é™¢å¯ç›´æ¥æ”¶æ²»</li>

                    </ul>
                    <p><strong>åŠ£åŠ¿ï¼š</strong></p>
                    <ul>

                        <li>ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼ˆçº¦70åˆ†é’Ÿï¼‰</li>

                        <li>æ€¥è¯Šç§‘ç›®å‰ç¹å¿™</li>

                    </ul>
                </div>
            </details>

            <p><strong>ğŸš¨ é£é™©è¯„ä¼°ï¼š</strong><br>
                è½¬é™¢é£é™©: <span class="risk-æ— ">æ— </span> | 
                å»¶è¯¯é£é™©: <span class="risk-ä¸­ç­‰">ä¸­ç­‰</span> | 
                èµ„æºä¸å¯ç”¨é£é™©: <span class="risk-æä½">æä½</span>
            </p>
        </div>

        <div class="decision-interactive">
            <label class="chip">
                <input type="checkbox" data-k="hospital.approve_priority_1"
                checked> 
                æ‰¹å‡†æ­¤æ¨è
            </label>
        </div>
    </div>

    <div class="hospital-recommendation" data-priority="2">
        <div class="hospital-header">
            <span class="priority-badge">æ¨è 2</span>
            <h5>ç¤¾åŒºåŒ»ç–—ä¸­å¿ƒ (äºŒçº§)</h5>

        </div>

        <div class="hospital-details">
            <p><strong>ğŸ¥ æ€¥è¯ŠçŠ¶æ€ï¼š</strong>ç•…é€š</p>
            <p><strong>â±ï¸ é¢„è®¡æ€»ç­‰å¾…æ—¶é—´ï¼š</strong>25 åˆ†é’Ÿ</p>
            <p><strong>ğŸ“‹ æ’é˜Ÿæƒ…å†µï¼š</strong>é å‰ï¼ˆé¢„è®¡ç¬¬2-4ä½ï¼‰</p>

            <p><strong>ğŸ”¬ èµ„æºåŒ¹é…åº¦ï¼š</strong>
                <span class="badge badge-low">
                    45%
                </span>
            </p>




            <div class="warning-info">
                <strong>âš ï¸ ç¼ºå°‘èµ„æºï¼š</strong><br>

                <span class="resource-item" style="display:inline-block; margin:4px 4px 4px 0; background:#fff;">è¶…å£°æ£€æŸ¥</span>

                <span class="resource-item" style="display:inline-block; margin:4px 4px 4px 0; background:#fff;">è¯Šæ–­æ€§ç©¿åˆºæ“ä½œ (è…°ç©¿/è…¹ç©¿/å…³èŠ‚ç©¿åˆº)</span>

            </div>


            <details>
                <summary><strong>ğŸ“‹ æ¨èç†ç”±</strong></summary>
                <p style="margin-top:8px; line-height:1.6;">å¦‚æœæ‚£è€…ç—‡çŠ¶è½»å¾®ã€ç”Ÿå‘½ä½“å¾ç¨³å®šï¼Œå¯å…ˆåˆ°ç¤¾åŒºåŒ»é™¢å®ŒæˆåŸºç¡€æ£€æŸ¥ï¼ˆè¡€å¸¸è§„ã€ç”ŸåŒ–ï¼‰ä»¥å¿«é€Ÿè¯„ä¼°ã€‚ä½†ç”±äºç¼ºä¹è…¹ç©¿èƒ½åŠ›ï¼Œå¦‚æœæ€€ç–‘SBPæˆ–ç—…æƒ…æ¶åŒ–ï¼Œä»éœ€è½¬è‡³ä¸‰çº§åŒ»é™¢ï¼Œå¯èƒ½é€ æˆæ—¶é—´å»¶è¯¯ã€‚</p>
            </details>

            <details>
                <summary><strong>âš–ï¸ ä¼˜åŠ£åŠ¿åˆ†æ</strong></summary>
                <div style="margin-top:8px;">
                    <p><strong>ä¼˜åŠ¿ï¼š</strong></p>
                    <ul>

                        <li>ç­‰å¾…æ—¶é—´çŸ­ï¼ˆçº¦25åˆ†é’Ÿï¼‰</li>

                        <li>æ€¥è¯Šç§‘ç›®å‰ç•…é€š</li>

                        <li>å¯å®ŒæˆåŸºç¡€æ£€æŸ¥å’Œåˆæ­¥è¯„ä¼°</li>

                    </ul>
                    <p><strong>åŠ£åŠ¿ï¼š</strong></p>
                    <ul>

                        <li>ç¼ºå°‘å…³é”®è¯Šæ–­èµ„æºï¼ˆè…¹ç©¿èƒ½åŠ›ï¼‰</li>

                        <li>å¦‚éœ€è¿›ä¸€æ­¥è¯Šç–—éœ€è½¬é™¢</li>

                    </ul>
                </div>
            </details>

            <p><strong>ğŸš¨ é£é™©è¯„ä¼°ï¼š</strong><br>
                è½¬é™¢é£é™©: <span class="risk-é«˜">é«˜</span> | 
                å»¶è¯¯é£é™©: <span class="risk-é«˜">é«˜</span> | 
                èµ„æºä¸å¯ç”¨é£é™©: <span class="risk-é«˜">é«˜</span>
            </p>
        </div>

        <div class="decision-interactive">
            <label class="chip">
                <input type="checkbox" data-k="hospital.approve_priority_2"
                > 
                æ‰¹å‡†æ­¤æ¨è
            </label>
        </div>
    </div>


    <div class="decision-interactive" style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:10px;">
        <label for="final-hospital-select" style="display:block; margin-bottom:8px;"><strong>ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿæœ€ç»ˆå†³å®šï¼š</strong></label>
        <select id="final-hospital-select" data-k="hospital.final_choice" style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border);">
            <option value="">-- è¯·é€‰æ‹©åŒ»é™¢ --</option>

            <option value="1" 
                selected>
                æ¨è1: å¸‚ä¸­å¿ƒåŒ»é™¢ (ä¸‰çº§ç”²ç­‰)
            </option>

            <option value="2" 
                >
                æ¨è2: ç¤¾åŒºåŒ»ç–—ä¸­å¿ƒ (äºŒçº§)
            </option>

        </select>
    </div>


    <details style="margin-top:16px; padding:12px; background:var(--card); border-radius:8px;">
        <summary style="cursor:pointer; font-weight:600; color:var(--btn);"><strong>ğŸ¤– ç³»ç»Ÿå†³ç­–ä¾æ®</strong></summary>
        <div style="margin-top:12px;">
            <p><strong>ESIç­‰çº§ï¼š</strong>3</p>
            <p><strong>å…³é”®å†³ç­–å› ç´ ï¼š</strong></p>
            <ul>

                <li>éœ€è¦è¯Šæ–­æ€§ç©¿åˆºï¼ˆä»…ä¸‰çº§åŒ»é™¢å¯æä¾›ï¼‰</li>

                <li>è‚ç¡¬åŒ–æ‚£è€…è…¹ç—›åŠ é‡ï¼Œéœ€ç´§æ€¥æ’æŸ¥è‡ªå‘æ€§ç»†èŒæ€§è…¹è†œç‚</li>

                <li>è™½ç­‰å¾…æ—¶é—´è¾ƒé•¿ï¼Œä½†é¿å…è½¬é™¢é£é™©æ›´é‡è¦</li>

            </ul>
        </div>
    </details>




---


<div id="path-home-observation"> 
    <h4>3.3 å»ºè®®å¤æŸ¥æ—¶é—´</h4>
    <div class="decision-interactive">
        <label for="followup-select">å¤æŸ¥æ—¶é—´:</label>
        <select id="followup-select" data-k="followup.time">
            <option value="12" >12å°æ—¶å†…</option>
            <option value="24" >24å°æ—¶å†…</option>
            <option value="48" >48å°æ—¶å†…</option>
        </select>
    </div>

    <h4>3.4 å±…å®¶æŠ¤ç†æªæ–½</h4>
    <div class="decision-interactive">
        <span>æ¨¡å‹å»ºè®®äº† 0 é¡¹æªæ–½ã€‚</span>
        <button class="btn-mini" data-act="edit-care-measures">ğŸ“ ç¼–è¾‘æŠ¤ç†æªæ–½</button>
    </div>

    <h4>3.5 è­¦å‘Šä¿¡å·</h4>
    <div class="decision-interactive">
        <span>æ¨¡å‹å»ºè®®äº† 0 é¡¹è­¦å‘Šä¿¡å·ã€‚</span>
        <button class="btn-mini" data-act="edit-warning-signs">ğŸ“ ç¼–è¾‘è­¦å‘Šä¿¡å·</button>
    </div>

    <h4>3.6 å±…å®¶æ¶åŒ–é£é™©</h4>
    <div class="decision-interactive">
        <label for="home-risk-select">æ¶åŒ–é£é™©:</label>
        <select id="home-risk-select" data-k="risk.home_deterioration">
            <option value="ä½" >ä½é£é™©</option>
            <option value="ä¸­" >ä¸­é£é™©</option>
            <option value="é«˜" selected>é«˜é£é™©</option>
        </select>
    </div>
</div>


<h4>3.7 æ€¥è¯Šå°±è¯Šè®°å½•ç¡®è®¤</h4>

<div class="physician-approval-form">
    <table class="approval-table">
        <tr>
            <td style="width:30%; font-weight:600;">è®°å½•ç”Ÿæˆæ—¶é—´ï¼š</td>
            <td>2025-10-07 20:55</td>
        </tr>
        <tr>
            <td style="font-weight:600;">è®°å½•äººï¼š</td>
            <td>
                <input type="text" class="form-input" data-k="approval.recorder_name" 
                       placeholder="è¯·è¾“å…¥è®°å½•äººå§“å" style="width:100%; padding:6px; border:1px solid var(--border); border-radius:4px;">
            </td>
        </tr>
        <tr>
            <td style="font-weight:600;">ç§‘å®¤/åœ°ç‚¹ï¼š</td>
            <td>
                <input type="text" class="form-input" data-k="approval.location" 
                       placeholder="è¯·è¾“å…¥ç§‘å®¤æˆ–åœ°ç‚¹" style="width:100%; padding:6px; border:1px solid var(--border); border-radius:4px;">
            </td>
        </tr>
        <tr>
            <td style="font-weight:600;">åˆ†è¯Šè¯„ä¼°å®¡æ ¸ï¼š</td>
            <td>
                <label style="margin-right:20px;">
                    <input type="radio" name="triage-review" value="agree" data-k="approval.triage_review"> åŒæ„
                </label>
                <label>
                    <input type="radio" name="triage-review" value="disagree" data-k="approval.triage_review"> ä¸åŒæ„
                </label>
            </td>
        </tr>
        <tr>
            <td style="font-weight:600;">åŒ»ç”Ÿç­¾åï¼š</td>
            <td>
                <input type="text" class="form-input signature-input" data-k="approval.physician_signature" 
                       placeholder="è¯·è¾“å…¥åŒ»ç”Ÿå§“å" style="width:100%; padding:6px; border:1px solid var(--border); border-radius:4px; font-style:italic;">
            </td>
        </tr>
    </table>
</div>
        <div id="resourceEditorModal" class="resource-modal">
            <div class="resource-modal-content">
                <div class="resource-modal-header">
                    <h3>ç¼–è¾‘æ€¥è¯Šèµ„æºéœ€æ±‚</h3>
                    <button id="closeResourceEditorBtn" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
                </div>
                <div id="resourceEditorContent" class="resource-modal-body"></div>
                <div class="resource-modal-footer">
                    <div id="resourceCount">å·²é€‰æ‹© <strong>0</strong> é¡¹</div>
                    <div>
                        <button id="cancelResourceSelectionBtn">å–æ¶ˆ</button>
                        <button id="saveResourceSelectionBtn" class="primary">ç¡®è®¤ä¿®æ”¹</button>
                    </div>
                </div>
            </div>
        </div>
        
</div>


<div class="anno-toolbar" id="annoToolbar">
    <button id="toggleAnno">å…³é—­æ‰¹æ³¨æ¨¡å¼</button>
    <div class="sep"></div>
    <button id="exportAnno">å¯¼å‡ºæ‰¹æ³¨ä¸äº¤äº’æ•°æ®</button>
    <label class="btn" for="importAnnoInput">å¯¼å…¥æ•°æ®</label>
    <input id="importAnnoInput" class="hidden-input" type="file" accept="application/json" />
    <button id="clearAnno">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
    <div class="sep"></div>
    <button id="printView">æ‰“å°å‹å¥½</button>
</div>


<script>
    window.TRIAGE_RESOURCES_DATA = {
        allResources: {"åºŠæ—è¯„ä¼°ä¸ç›‘æŠ¤": [{"id": "BS-AM-001", "name": "ç”Ÿå‘½ä½“å¾ä¸å¿ƒç”µç›‘æŠ¤ (Vital Signs & Cardiac Monitoring)"}, {"id": "BS-AM-002", "name": "åºŠæ—å¿«é€Ÿæ£€æµ‹(è¡€ç³–/é…®ä½“/å°¿è¯•çº¸)"}, {"id": "BS-AM-003", "name": "ä½“æ ¼æ£€æŸ¥ (Physical Examination)"}, {"id": "BS-AM-004", "name": "é‡ç‚¹ä¸“ç§‘åºŠæ—è¯„ä¼°(ç¥ç»/å‘¼å¸/è¡€ç®¡/POCUS)"}], "å®éªŒå®¤æ£€æŸ¥ - è¡€æ¶²å­¦": [{"id": "LAB-HE-001", "name": "è¡€å¸¸è§„ (Complete Blood Count - CBC)"}, {"id": "LAB-HE-002", "name": "D-äºŒèšä½“"}], "å®éªŒå®¤æ£€æŸ¥ - ç”ŸåŒ–": [{"id": "LAB-CH-001", "name": "åŸºç¡€/å…¨é¢ä»£è°¢åŠŸèƒ½ç»„åˆ (BMP/CMP)"}, {"id": "LAB-CH-002", "name": "å¿ƒè„æ ‡å¿—ç‰©ç»„åˆ (è‚Œé’™è›‹ç™½/BNP)"}, {"id": "LAB-CH-003", "name": "ç‚ç—‡æ ‡å¿—ç‰© (CRP/PCT/ESR)"}, {"id": "LAB-CH-004", "name": "ç‰¹å®šå™¨å®˜åŠŸèƒ½æ ‡å¿—ç‰© (è„‚è‚ªé…¶/è‚åŠŸ/CK)"}, {"id": "LAB-CH-005", "name": "ä¹³é…¸/æ¯’ç†å­¦ç­›æŸ¥"}], "å®éªŒå®¤æ£€æŸ¥ - å‡è¡€": [{"id": "LAB-CO-001", "name": "å‡è¡€åŠŸèƒ½ (PT/INR, PTT)"}], "å®éªŒå®¤æ£€æŸ¥ - å†…åˆ†æ³Œ": [{"id": "LAB-EN-001", "name": "æ¿€ç´ /å†…åˆ†æ³Œæ£€æµ‹ (ç”²çŠ¶è…º/HCG/çš®è´¨é†‡)"}], "å®éªŒå®¤æ£€æŸ¥ - è¡€æ°”": [{"id": "LAB-GA-001", "name": "åŠ¨/é™è„‰è¡€æ°”åˆ†æ (ABG/VBG)"}], "å®éªŒå®¤æ£€æŸ¥ - å°¿æ¶²": [{"id": "LAB-UR-001", "name": "å°¿æ¶²åˆ†æåŠé•œæ£€"}], "å®éªŒå®¤æ£€æŸ¥ - å¾®ç”Ÿç‰©": [{"id": "LAB-MI-001", "name": "å„ç±»æ ‡æœ¬åŸ¹å…»åŠæ¶‚ç‰‡(è¡€/å°¿/ç—°/ä¼¤å£)"}, {"id": "LAB-MI-002", "name": "æ„ŸæŸ“æ€§ç–¾ç—…å¿«é€Ÿæ£€æµ‹/PCR (æµæ„Ÿ/COVID-19/C.diff)"}, {"id": "LAB-MI-003", "name": "ä½“æ¶²åˆ†æ(è„‘è„Šæ¶²/èƒ¸è…¹æ°´/å…³èŠ‚æ¶²)"}, {"id": "LAB-MI-004", "name": "è¡€æ¸…å­¦/ç‰¹æ®Šç—…åŸä½“æ£€æµ‹ (HIV/è‚ç‚/è±å§†ç—…)"}], "å½±åƒæ£€æŸ¥": [{"id": "DX-IM-001", "name": "Xå…‰æ£€æŸ¥"}, {"id": "DX-IM-002", "name": "CTæ‰«æ"}, {"id": "DX-IM-003", "name": "è¶…å£°æ£€æŸ¥"}, {"id": "DX-IM-004", "name": "ç£å…±æŒ¯æˆåƒ (MRI)"}, {"id": "DX-IM-005", "name": "æ ¸åŒ»å­¦æ‰«æ (V/Q, HIDA)"}], "å¿ƒè„/ç¥ç»ç”µç”Ÿç†": [{"id": "DX-AC-001", "name": "12å¯¼è”å¿ƒç”µå›¾ (ECG/EKG)"}, {"id": "DX-AC-002", "name": "é«˜çº§å¿ƒè„/ç¥ç»ç”µç”Ÿç†æ£€æŸ¥ (Holter/EEG)"}], "å…¶ä»–æ£€æŸ¥": [{"id": "DX-OS-001", "name": "è¡€ç®¡é€ å½±/ä»‹å…¥æ“ä½œ"}, {"id": "DX-OS-002", "name": "å†…é•œæ£€æŸ¥ (EGD/æ”¯æ°”ç®¡é•œ)"}, {"id": "DX-OS-003", "name": "è¯Šæ–­æ€§ç©¿åˆºæ“ä½œ (è…°ç©¿/è…¹ç©¿/å…³èŠ‚ç©¿åˆº)"}]},
        suggestedIds: ["BS-AM-001", "BS-AM-003", "LAB-HE-001", "LAB-CH-001", "LAB-CH-004", "LAB-CO-001", "LAB-UR-001", "LAB-MI-001", "DX-IM-001", "DX-IM-003", "DX-OS-003"]
    };
</script>

<script>

    (() => {
    // ==================== A. é€šç”¨æ ¸å¿ƒå˜é‡ä¸å‡½æ•° ====================
    const patientId = document.querySelector('.page-container')?.dataset?.patientId || 'unknown';
    const reportType = document.querySelector('.page-container')?.dataset?.reportType || 'triage';
    const reportId = document.querySelector('.page-container')?.dataset?.reportId || '20251007_205510';
    const LS_ANNOTATIONS = `report-annotations::${reportType}::${patientId}::${reportId}`;
    const LS_GLOBAL = `report-annotations-global::${reportType}::${patientId}::${reportId}`;
    const LS_INTERACTIONS = `report-interactions::${reportType}::${patientId}::${reportId}`;
    let annoMode = true;

    function nowStr() {
      const d = new Date();
      const pad = n => (n<10? '0'+n : ''+n);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function loadJSON(key, def) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
    function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val || {})); }
    function loadAnnotations() { return loadJSON(LS_ANNOTATIONS, {}); }
    function saveAnnotations(data) { saveJSON(LS_ANNOTATIONS, data); }
    function loadGlobal() { return localStorage.getItem(LS_GLOBAL) || ''; }
    function saveGlobal(val) { localStorage.setItem(LS_GLOBAL, val || ''); }
    function loadInteracts() { return loadJSON(LS_INTERACTIONS, {}); }
    function saveInteracts(obj) { saveJSON(LS_INTERACTIONS, obj); }

    // ==================== B. èµ„æºç¼–è¾‘å™¨ä¸“å±é€»è¾‘ ====================
    function setupResourceEditor() {
        if (!window.TRIAGE_RESOURCES_DATA) return;
        const { allResources: ALL_RESOURCES, suggestedIds: SYSTEM_SUGGESTED_IDS } = window.TRIAGE_RESOURCES_DATA;
        let currentSelectedResourceIds = new Set();
        const STORAGE_KEY = 'triage_resources_selection';
        const editButton = document.querySelector('[data-act="edit-resources"]');
        if (!editButton) return;
        const modal = document.getElementById('resourceEditorModal');
        const modalBody = document.getElementById('resourceEditorContent');
        const displayAreaList = document.querySelector('#resource-display-area .resource-list');
        const confirmBtn = document.querySelector('.resource-modal-footer button.primary');
        const cancelBtn = document.querySelector('.resource-modal-footer button:not(.primary)');
        const closeIconBtn = document.querySelector('.resource-modal-header button');
        const countDisplay = document.querySelector('#resourceCount strong');

        function initializeState() {
            currentSelectedResourceIds.clear();
            const store = loadInteracts();
            const savedSelection = store[STORAGE_KEY];
            if (savedSelection && Array.isArray(savedSelection)) {
                currentSelectedResourceIds = new Set(savedSelection);
                console.log('âœ… [èµ„æº] åŠ è½½å·²ä¿å­˜çš„é€‰æ‹©:', savedSelection.length, 'é¡¹');
            } else {
                currentSelectedResourceIds = new Set(SYSTEM_SUGGESTED_IDS);
                store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
                saveInteracts(store);
                console.log('âœ… [èµ„æº] ä½¿ç”¨ç³»ç»Ÿæ¨èå¹¶å·²ä¿å­˜:', SYSTEM_SUGGESTED_IDS.length, 'é¡¹');
            }
        }

        function updateCounter() {
            const count = modalBody.querySelectorAll('input:checked').length;
            if(countDisplay) countDisplay.textContent = count;
        }

        function openResourceEditor() {
            initializeState();
            modalBody.innerHTML = '';
            Object.entries(ALL_RESOURCES).forEach(([category, resources]) => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                modalBody.appendChild(categoryTitle);
                resources.forEach(item => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = item.id;
                    checkbox.checked = currentSelectedResourceIds.has(item.id);
                    checkbox.onchange = updateCounter;
                    label.appendChild(checkbox);
                    label.append(` ${item.name}`);
                    if(SYSTEM_SUGGESTED_IDS.includes(item.id)) {
                        const badge = document.createElement('span');
                        badge.className = 'system-badge';
                        badge.textContent = '[ç³»ç»Ÿæ¨è]';
                        label.appendChild(badge);
                    }
                    modalBody.appendChild(label);
                });
            });
            updateCounter();
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeResourceEditor() {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function saveResourceSelection() {
            currentSelectedResourceIds = new Set(Array.from(modalBody.querySelectorAll('input:checked')).map(cb => cb.value));
            const store = loadInteracts();
            store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
            saveInteracts(store);
            console.log('ğŸ’¾ [èµ„æº] å·²ä¿å­˜é€‰æ‹©:', store[STORAGE_KEY].length, 'é¡¹');
            renderDisplayArea();
            closeResourceEditor();
        }
        
        function renderDisplayArea() {
            if(!displayAreaList) return;
            displayAreaList.innerHTML = '';
            const selectedByCategory = {};
            const allResourcesFlat = Object.values(ALL_RESOURCES).flat();
            currentSelectedResourceIds.forEach(id => {
                const item = allResourcesFlat.find(i => i.id === id);
                if(item) {
                    const category = item.category || 'æœªåˆ†ç±»';
                    if (!selectedByCategory[category]) selectedByCategory[category] = [];
                    selectedByCategory[category].push(item);
                }
            });
            if (Object.keys(selectedByCategory).length === 0) {
                displayAreaList.innerHTML = '<li>åŒ»ç”Ÿæœªé€‰æ‹©ä»»ä½•èµ„æºã€‚</li>';
                return;
            }
            Object.entries(selectedByCategory).forEach(([categoryName, items]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${categoryName}:</strong> `;
                items.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'resource-item';
                    if (!SYSTEM_SUGGESTED_IDS.includes(item.id)) span.classList.add('added-by-user');
                    span.textContent = item.name;
                    li.appendChild(span);
                });
                displayAreaList.appendChild(li);
            });
        }
        
        if (editButton) editButton.addEventListener('click', openResourceEditor);
        if (confirmBtn) confirmBtn.addEventListener('click', saveResourceSelection);
        if (cancelBtn) cancelBtn.addEventListener('click', closeResourceEditor);
        if (closeIconBtn) closeIconBtn.addEventListener('click', closeResourceEditor);
        initializeState();
        renderDisplayArea();
    }

    // ==================== C. é€šç”¨æ‰¹æ³¨ä¸äº¤äº’é€»è¾‘ ====================
    const SectionKindMap = [];

    function setupSectionAnchors() {
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach((h, idx) => {
        if (!h.id) {
            const text = h.textContent.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '').substring(0, 15);
            h.id = text ? `sec-${text}-${idx}` : `sec-${idx}`;
        }
        const btn = document.createElement('button');
        btn.className = 'add-note-btn';
        btn.textContent = 'â• æ‰¹æ³¨';
        btn.addEventListener('click', () => createNoteCard(h.id));
        h.appendChild(btn);
      });
    }

    function refreshAnnoButtons() {
      document.querySelectorAll('.add-note-btn').forEach(b => b.style.display = annoMode ? 'inline-block' : 'none');
    }

    function renderNotes() {
      const store = loadAnnotations();
      Object.entries(store).forEach(([secId, arr]) => {
        const anchor = document.getElementById(secId);
        if (anchor) arr.forEach(n => insertNoteCardAfter(anchor, n));
      });
    }

    function createNoteCard(secId) {
      const payload = { id: `n-${Date.now()}`, ts: nowStr(), html: '' };
      const store = loadAnnotations();
      (store[secId] = store[secId] || []).push(payload);
      saveAnnotations(store);
      const anchor = document.getElementById(secId);
      if (anchor) insertNoteCardAfter(anchor, payload, true);
    }

    function insertNoteCardAfter(anchorEl, note, focus=false) {
      const card = document.createElement('div');
      card.className = 'anno-card';
      card.dataset.noteId = note.id;
      card.dataset.secId = anchorEl.id;
      card.innerHTML = `<div class="anno-head"><div>ç« èŠ‚ï¼š<code>${anchorEl.textContent.replace('â• æ‰¹æ³¨','').trim()}</code></div><div>æ—¶é—´ï¼š${note.ts}</div></div><div class="anno-body" contenteditable="true" spellcheck="false">${note.html || ''}</div><div class="anno-actions"><button data-act="del">åˆ é™¤</button></div>`;
      const body = card.querySelector('.anno-body');
      body.addEventListener('input', () => {
        const store = loadAnnotations();
        const item = (store[card.dataset.secId] || []).find(x => x.id === card.dataset.noteId);
        if (item) { item.html = body.innerHTML; saveAnnotations(store); }
      });
      card.querySelector('[data-act="del"]').addEventListener('click', () => {
        const store = loadAnnotations();
        let list = store[card.dataset.secId] || [];
        store[card.dataset.secId] = list.filter(x => x.id !== card.dataset.noteId);
        saveAnnotations(store);
        card.remove();
      });
      anchorEl.parentNode.insertBefore(card, anchorEl.nextSibling);
      if (focus) body.focus();
    }

    function injectToolsHTML() {
      if (!SectionKindMap || SectionKindMap.length === 0) return;
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
          const titleText = (h.textContent || '').replace(/[\sâ•æ‰¹æ³¨]/g, '');
          const config = SectionKindMap.find(m => m.includes && m.includes.some(k => titleText.includes(k)));
          if (config && config.tools_html) {
              const wrap = document.createElement('span');
              wrap.className = 'section-tools';
              wrap.innerHTML = config.tools_html;
              h.appendChild(wrap);
          }
      });
    }

    function activateInteractiveElements() {
        const store = loadInteracts();
        let hasNewValues = false;
        
        document.querySelectorAll('[data-k]').forEach(el => {
            let header = el.closest('h1, h2, h3, h4');
            if (!header) {
                const wrapper = el.closest('.decision-interactive, .physician-approval-form');
                if (wrapper && wrapper.previousElementSibling?.matches('h1, h2, h3, h4')) {
                    header = wrapper.previousElementSibling;
                }
            }
            
            if (!header) {
                console.warn('âš ï¸ [äº¤äº’] æ— æ³•æ‰¾åˆ°æ ‡é¢˜ï¼Œè·³è¿‡å…ƒç´ :', el.dataset.k);
                return;
            }
            
            const k = `${header.id}::${el.dataset.k}`;
            const savedValue = store[k];
            
            let currentValue;
            if (el.tagName === 'SELECT') {
                currentValue = el.value;
            } else if (el.type === 'checkbox') {
                currentValue = el.checked;
            } else if (el.type === 'radio') {
                if (el.checked) {
                    currentValue = el.value;
                }
            } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                currentValue = el.value;
            }
            
            if (savedValue !== undefined) {
                if (el.tagName === 'SELECT') {
                    el.value = savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤ä¸‹æ‹‰æ¡†:', k, '=', savedValue);
                } else if (el.type === 'checkbox') {
                    el.checked = !!savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤å¤é€‰æ¡†:', k, '=', savedValue);
                } else if (el.type === 'radio') {
                    if (el.value === savedValue) {
                        el.checked = true;
                        console.log('ğŸ”„ [äº¤äº’] æ¢å¤å•é€‰æ¡†:', k, '=', savedValue);
                    }
                } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.value = savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤è¾“å…¥æ¡†:', k, '=', savedValue);
                }
            } else if (currentValue !== '' && currentValue !== undefined) {
                store[k] = currentValue;
                hasNewValues = true;
                console.log('ğŸ’¾ [äº¤äº’] ä¿å­˜é¢„è®¾å€¼:', k, '=', currentValue);
            }
            
            el.addEventListener('change', () => {
                const cur = loadInteracts();
                if (el.type === 'checkbox') {
                    cur[k] = el.checked;
                } else if (el.type === 'radio') {
                    cur[k] = el.value;
                } else {
                    cur[k] = el.value;
                }
                saveInteracts(cur);
                console.log('ğŸ’¾ [äº¤äº’] ä¿å­˜:', k, '=', cur[k]);
            });
        });
        
        if (hasNewValues) {
            saveInteracts(store);
            console.log('âœ… [äº¤äº’] å·²ä¿å­˜æ‰€æœ‰é¢„è®¾å€¼åˆ°localStorage');
        }
    }

    function setupPathSwitching() {
        const switcher = document.querySelector('.path-switcher-select');
        const pathYes = document.getElementById('path-immediate-care');
        const pathNo = document.getElementById('path-home-observation');
        if (!switcher || !pathYes || !pathNo) return; 
        const handleSwitch = () => {
            pathYes.style.display = (switcher.value === 'yes') ? 'block' : 'none';
            pathNo.style.display = (switcher.value === 'no') ? 'block' : 'none';
        };
        switcher.addEventListener('change', handleSwitch);
        handleSwitch();
    }

    function setupToolbar() {
      const $toggle = document.getElementById('toggleAnno'), $export = document.getElementById('exportAnno'), $import = document.getElementById('importAnnoInput'), $clear = document.getElementById('clearAnno'), $print = document.getElementById('printView'), $global = document.getElementById('globalAnnoArea');
      $global.value = loadGlobal();
      $global.addEventListener('input', () => saveGlobal($global.value));
      $toggle.addEventListener('click', () => {
        annoMode = !annoMode;
        $toggle.textContent = annoMode ? 'å…³é—­æ‰¹æ³¨æ¨¡å¼' : 'å¼€å¯æ‰¹æ³¨æ¨¡å¼';
        refreshAnnoButtons();
      });
      $export.addEventListener('click', () => {
        const data = { patient_id: patientId, report_type: reportType, report_id: reportId, exported_at: nowStr(), global: $global.value || '', sections: loadAnnotations(), interactions: loadInteracts() };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = `annotations_${reportType}_${patientId}_${reportId}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      $import.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (data?.global !== undefined) saveGlobal(data.global);
            if (data?.sections) saveAnnotations(data.sections);
            if (data?.interactions) saveInteracts(data.interactions);
            location.reload();
          } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼ä¸æ­£ç¡®'); }
        };
        reader.readAsText(f, 'utf-8');
        e.target.value = '';
      });
      $clear.addEventListener('click', () => {
        if (confirm('ç¡®å®šæ¸…ç©ºæœ¬æŠ¥å‘Šçš„æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')) {
            localStorage.removeItem(LS_ANNOTATIONS);
            localStorage.removeItem(LS_GLOBAL);
            localStorage.removeItem(LS_INTERACTIONS);
            location.reload();
        }
      });
      $print.addEventListener('click', () => window.print());
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupSectionAnchors();
        injectToolsHTML();
        activateInteractiveElements();
        setupPathSwitching();
        setupResourceEditor();
        renderNotes();
        setupToolbar();
        refreshAnnoButtons();
    });

    })();
</script>
</body>
</html>